<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aluminum Cutting</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        .status-btn {
            padding: 5px 10px;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        .status-btn.false {
            background-color: red;
        }
        .status-btn.true {
            background-color: green;
        }
        .table-container {
            display: none; /* إخفاء الجداول بشكل افتراضي */
            margin-top: 20px;
        }
        .table-container.active {
            display: block; /* عرض الجدول عند تفعيل الكلاس */
        }
        .form-container {
            margin-bottom: 20px;
        }
        .button-container {
            margin-bottom: 20px;
        }
    </style>
    <script>
        function showTable(tableId) {
            const tables = document.querySelectorAll('.table-container');
            tables.forEach(table => {
                table.classList.remove('active');
            });
            document.getElementById(tableId).classList.add('active');
        }

        // عرض الجدول الأساسي عند تحميل الصفحة لأول مرة
        document.addEventListener('DOMContentLoaded', (event) => {
            showTable('all-table');
        });
    </script>
</head>
<body>
    <h1>Aluminum Cutting</h1>
    <div class="button-container">
        <button onclick="showTable('all-table')">All</button>
        <button onclick="showTable('cutting-table')">Cutting</button>
        <button onclick="showTable('assembly-table')">Assembly</button>
    </div>

    <div id="all-table" class="table-container">
        <form action="/aluminum-cutting/assign" method="POST">
            <input type="hidden" name="idCustomer" value="<%= idCustomer %>">
            <input type="hidden" name="orderId" value="<%= foundOrder._id %>">

            <table>
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Cutting Technician</th>
                        <th>Cutting Status</th>
                        <th>Assembly Technician</th>
                        <th>Assembly Status</th>
                        <th>Sequence Number</th>
                        <th>Aluminum Code</th>
                        <th>Color Code</th>
                        <th>H(A1)*2</th>
                        <th>W(A2)*2</th>
                        <th>(B1)*2</th>
                        <th>(B2)*4</th>
                        <th>(B3)*2</th>
                        <th>(N1)*2</th>
                        <th>(N2)*2</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (foundOrder.measurement && Array.isArray(foundOrder.measurement)) { %>
                        <% foundOrder.measurement.forEach(measurement => { %>
                            <tr>
                                <td><input type="checkbox" name="selectedMeasurements" value="<%= measurement._id %>"></td>
                                <td><%= measurement.cuttingTechnician ? technicians.find(t => t._id.toString() === measurement.cuttingTechnician.toString()).name : '--' %></td>
                                <td>
                                    <button type="button" class="status-btn <%= measurement.cuttingStatus %>">
                                        <%= measurement.cuttingStatus ? 'Completed' : 'In Progress' %>
                                    </button>
                                </td>
                                <td><%= measurement.assemblyTechnician ? technicians.find(t => t._id.toString() === measurement.assemblyTechnician.toString()).name : '--' %></td>
                                <td>
                                    <button type="button" class="status-btn <%= measurement.assemblyStatus %>">
                                        <%= measurement.assemblyStatus ? 'Completed' : 'In Progress' %>
                                    </button>
                                </td>
                                <td><%= measurement.sequenceNumber || '--' %></td>
                                <td><%= measurement.aluminumCode || '--' %></td>
                                <td><%= measurement.aluminumColorCode || '--' %></td>
                                <td><%= (measurement.H ? measurement.H * 2 : '--') %></td>
                                <td><%= (measurement.W ? measurement.W * 2 : '--') %></td>
                                <td><%= (measurement.aluminumCuttingReport && measurement.aluminumCuttingReport.U4 ? measurement.aluminumCuttingReport.U4 * 2 : '--') %></td>
                                <td><%= (measurement.aluminumCuttingReport && measurement.aluminumCuttingReport.T4 ? measurement.aluminumCuttingReport.T4 * 4 : '--') %></td>
                                <td><%= (measurement.aluminumCuttingReport && measurement.aluminumCuttingReport.S4 ? measurement.aluminumCuttingReport.S4 * 2 : '--') %></td>
                                <td><%= (measurement.aluminumCuttingReport && measurement.aluminumCuttingReport.R4 ? measurement.aluminumCuttingReport.R4 * 2 : '--') %></td>
                                <td><%= (measurement.aluminumCuttingReport && measurement.aluminumCuttingReport.Q4 ? measurement.aluminumCuttingReport.Q4 * 2 : '--') %></td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="15">No measurements found</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>

            <label for="taskType">Select Task Type:</label>
            <select name="taskType" id="taskType">
                <option value="cutting">Cutting</option>
                <option value="assembly">Assembly</option>
            </select>

            <label for="technicianId">Select Technician:</label>
            <select name="technicianId" id="technicianId">
                <% technicians.forEach(technician => { %>
                    <option value="<%= technician._id %>"><%= technician.name %> - <%= technician.role %></option>
                <% }) %>
            </select>

            <button type="submit">Assign</button>
        </form>
    </div>

    <div id="cutting-table" class="table-container">
        <h2>Cutting Status</h2>
        <table>
            <thead>
                <tr>
                    <th>Sequence Number</th>
                    <th>Aluminum Code</th>
                    <th>Color Code</th>
                    <th>Technician</th>
                    <th>H(A1)*2</th>
                    <th>W(A2)*2</th>
                    <th>(B1)*2</th>
                    <th>(B2)*4</th>
                    <th>(B3)*2</th>
                    <th>(N1)*2</th>
                    <th>(N2)*2</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <% foundOrder.measurement.forEach(measurement => { if (measurement.cuttingTechnician) { %>
                    <tr>
                        <td><%= measurement.sequenceNumber || '--' %></td>
                        <td><%= measurement.aluminumCode || '--' %></td>
                        <td><%= measurement.aluminumColorCode || '--' %></td>
                        <td><%= technicians.find(t => t._id.toString() === measurement.cuttingTechnician.toString()).name %></td>
                        <td><%= (measurement.H ? measurement.H * 2 : '--') %></td>
                        <td><%= (measurement.W ? measurement.W * 2 : '--') %></td>
                        <td><%= (measurement.aluminumCuttingReport && measurement.aluminumCuttingReport.U4 ? measurement.aluminumCuttingReport.U4 * 2 : '--') %></td>
                        <td><%= (measurement.aluminumCuttingReport && measurement.aluminumCuttingReport.T4 ? measurement.aluminumCuttingReport.T4 * 4 : '--') %></td>
                        <td><%= (measurement.aluminumCuttingReport && measurement.aluminumCuttingReport.S4 ? measurement.aluminumCuttingReport.S4 * 2 : '--') %></td>
                        <td><%= (measurement.aluminumCuttingReport && measurement.aluminumCuttingReport.R4 ? measurement.aluminumCuttingReport.R4 * 2 : '--') %></td>
                        <td><%= (measurement.aluminumCuttingReport && measurement.aluminumCuttingReport.Q4 ? measurement.aluminumCuttingReport.Q4 * 2 : '--') %></td>
                        <td>
                            <form action="/aluminum-cutting/update-status" method="POST">
                                <input type="hidden" name="idCustomer" value="<%= idCustomer %>">
                                <input type="hidden" name="orderId" value="<%= foundOrder._id %>">
                                <input type="hidden" name="measurementId" value="<%= measurement._id %>">
                                <input type="hidden" name="taskType" value="cutting">
                                <button type="submit" class="status-btn <%= measurement.cuttingStatus %>">
                                    <%= measurement.cuttingStatus ? 'Completed' : 'In Progress' %>
                                </button>
                            </form>
                        </td>
                    </tr>
                <% } }) %>
            </tbody>
        </table>
    </div>

    <div id="assembly-table" class="table-container">
        <h2>Assembly Status</h2>
        <table>
            <thead>
                <tr>
                    <th>Sequence Number</th>
                    <th>Aluminum Code</th>
                    <th>Color Code</th>
                    <th>Technician</th>
                    <th>H(A1)*2</th>
                    <th>W(A2)*2</th>
                    <th>(B1)*2</th>
                    <th>(B2)*4</th>
                    <th>(B3)*2</th>
                    <th>(N1)*2</th>
                    <th>(N2)*2</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <% foundOrder.measurement.forEach(measurement => { if (measurement.assemblyTechnician) { %>
                    <tr>
                        <td><%= measurement.sequenceNumber || '--' %></td>
                        <td><%= measurement.aluminumCode || '--' %></td>
                        <td><%= measurement.aluminumColorCode || '--' %></td>
                        <td><%= technicians.find(t => t._id.toString() === measurement.assemblyTechnician.toString()).name %></td>
                        <td><%= (measurement.H ? measurement.H * 2 : '--') %></td>
                        <td><%= (measurement.W ? measurement.W * 2 : '--') %></td>
                        <td><%= (measurement.aluminumCuttingReport && measurement.aluminumCuttingReport.U4 ? measurement.aluminumCuttingReport.U4 * 2 : '--') %></td>
                        <td><%= (measurement.aluminumCuttingReport && measurement.aluminumCuttingReport.T4 ? measurement.aluminumCuttingReport.T4 * 4 : '--') %></td>
                        <td><%= (measurement.aluminumCuttingReport && measurement.aluminumCuttingReport.S4 ? measurement.aluminumCuttingReport.S4 * 2 : '--') %></td>
                        <td><%= (measurement.aluminumCuttingReport && measurement.aluminumCuttingReport.R4 ? measurement.aluminumCuttingReport.R4 * 2 : '--') %></td>
                        <td><%= (measurement.aluminumCuttingReport && measurement.aluminumCuttingReport.Q4 ? measurement.aluminumCuttingReport.Q4 * 2 : '--') %></td>
                        <td>
                            <form action="/aluminum-cutting/update-status" method="POST">
                                <input type="hidden" name="idCustomer" value="<%= idCustomer %>">
                                <input type="hidden" name="orderId" value="<%= foundOrder._id %>">
                                <input type="hidden" name="measurementId" value="<%= measurement._id %>">
                                <input type="hidden" name="taskType" value="assembly">
                                <button type="submit" class="status-btn <%= measurement.assemblyStatus %>">
                                    <%= measurement.assemblyStatus ? 'Completed' : 'In Progress' %>
                                </button>
                            </form>
                        </td>
                    </tr>
                <% } }) %>
            </tbody>
        </table>
    </div>
</body>
</html>
